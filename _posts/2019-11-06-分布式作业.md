---
layout:     post
title:      分布式作业
title:      2333
date:       2019-11-06
author:     bbkgl
header-img: img/post-bg-0011.jpg
catalog: true
tags:
    - Blog
---

# 作业：分布式文件系统bdfs

> 姓名：邹佳坤
>
> 学号：21951159
>
> 指导教师：刘二腾
>
> language：Go 1.13.1
>
> 运行环境：Ubuntu 16.04 LTS

bdfs是一个使用Go语言实现的分布式文件系统，使用主从结构，一个introducer节点，一个master节点，多个成员节点，往后新的master结点由选举产生。同一份文件会有4个备份文件存放在4个不同的结点上，达到高可靠性。

[TOC]

## 1 使用和展示

考虑到分布式集群部署的成本，这里的展示全部通过一台机器，以多个不同的端口模拟多个不同服务器。其中introducer结点端口默认为9123，方便进行通信。

### 1.1 分布式文件系统启动

这里将可执行程序放到四个不同的位置，启动分布式系统。

首先启动master节点：

![](https://ae01.alicdn.com/kf/H93e9c96ab2594ee5bd32031cc2b03b4aL.jpg)

以下每启动一个节点，就会自动加入到集群中，master节点会收到消息。

启动端口号为6666的节点：

![](https://ae01.alicdn.com/kf/Ha8388e542fea4e6da12cbbe2a882b499Y.jpg)启动端口号为7777的节点：

![](https://ae01.alicdn.com/kf/H0295bc6e73f84219a7a1aeaf8615b9d7b.jpg)

启动端口号为8888的节点：

![](https://ae01.alicdn.com/kf/H3d22f614f1ea4f0f80ceb209bb2a4711o.jpg)

可以看到，每个节点启动后都会加入到集群中，而且会被告知当前master节点的host信息。

可以看下introducer节点收到信息：

![](https://ae01.alicdn.com/kf/H2d97c197403b4721a84113fedd81ce47s.jpg)

可以看到，每新加入一个节点，introducer就会收到加入请求，并回复对方，同样如果有节点挂掉了，introducer节点也会收到消息，这个由心跳机制实现。

### 1.2 文件系统通信展示

本系统支持多个命令来查看集群信息。

`ping`命令，可以查看集群中和本节点通信的节点列表：

![1573020453998](../../../.config/Typora/typora-user-images/1573020453998.png)

`membership`命令，查看集群中所有通信节点列表：

![](https://ae01.alicdn.com/kf/H6ab065a0b0734df296d9283f405b9eb7u.jpg)

`id`命令，查看当前节点host信息：

![](https://ae01.alicdn.com/kf/H94dafee8c2cc4ead87cdd259b7fca7c91.jpg)

以及`intro`和`master`命令，查看集群中哪个是introducer节点和master节点：

![](https://ae01.alicdn.com/kf/H90fca19ca6c8497fa625a5f38d5a8494y.jpg)

### 1.3 分布式文件操作

上传文件`put ../test.txt test`：

![](https://ae01.alicdn.com/kf/H59f8cda9428b4c98af99c28b46414391D.jpg)

从另一个节点下载文件`get test test.txt`：

![](https://ae01.alicdn.com/kf/Ha35c86ab724f494296df467ef743b34cC.jpg)

使用`store`命令和`ls test`命令查看文件存储信息：

![](https://ae01.alicdn.com/kf/H0870d8d0072f4897892345a962b8f2b1m.jpg)

删除文件`delete test`：

![](https://ae01.alicdn.com/kf/H56a7cec020d8467a848764f1a8735f46G.jpg)

### 1.4 节点挂掉演示

1. 如果是普通节点挂掉：

   ![](https://ae01.alicdn.com/kf/H9f78233d26974d3cb821746f05945c41p.jpg)

   可以看到master节点立马发现节点挂掉，会立即更新数据节点信息，进行备份操作。

2. 如果是master节点挂掉：

   ![](https://ae01.alicdn.com/kf/H09d1546e911f4f25a27cecb2a3f42f11S.jpg)

   立即重新选举产生新的master节点。

3. 如果是introducer节点挂掉呢？

   好吧，这就有点麻烦了，时间原因，暂时没做处理了，以后会继续完善的。

## 2 分布式通信调度

对于任何一个分布式系统或者是子系统来说，分布式通信都是最基础的，本系统也不例外。分布式通信实现以后，就可以知道哪个节点当前这个组中，并且能知道每个节点的状态。于是可以使用心跳机制去检测某个节点是否发生了故障，或者崩溃，便于后续的数据备份处理。

### 2.1 通信协议

为了让每个节点间能够进行简单高效的交流，bdfs中创造了一种十分简单的通信协议。简单来说，如果节点收到的是规定的类型，就会按照规定的操作执行。

协议内容如下表：
|   类型   |                  说明                  |
| :------: | :------------------------------------: |
|   JOIN   | 新加入节点发送给introducer节点请求加入 |
|   NONE   |        表示发生了某些未知的故障        |
| JOINACK  | introducer节点回复确认新节点的加入请求 |
|  UPDATE  |       发送给其他节点完善更新信息       |
| DELNODE  |       删除某个崩溃或者退出的节点       |
|   PING   |                心跳信息                |
|   ACK    |                回复心跳                |
| ASKLIST  |           收到的心跳回复列表           |
| PINGLIST |     由introducer发送的新的ping列表     |



```go
// 消息类型结构体
type Msg struct {
	MsgType     int    `json:"msgType"`
	MsgSourceID string `json:"sourceID"`
	MsgContent  string `json:"content"`
}

// 协议中消息的类型
const (
	NONE = iota
	JOIN
	JOINACK
	UPDATE
	DELNODE
	PING
	ACK
	PINGNODES
	MEMBERSHIP
	ASKLIST

	LSREQUEST
	LSRESPONSE


	STOREFILE
	SENDREQUEST
	GETFILE
	GETRESPOND

	DELETEREQUEST
	DELETEFILE
	DELETEACK

	DBASKFILE
	DBASKRESPOND

	DBSYNC
	// 选举消息
	ELECTION
	ELECTED
)
```

### 2.2 通信机制

在本分布式文件系统中，有一个introducer负责管理和接收成员的加入。集群中的每个节点由IP+端口号+时间戳唯一确定，并对应一个NODEID。当一个新的节点想加入时，会发送“Join”（并以上述通信协议中的JOIN枚举类型发送），introducer节点回复“JoinACK”（并以上述通信协议中的JOINACK枚举类型发送），然后开始发送心跳ping包以及pinglist包。

pinglist的使用是出于扩展考虑，它用于不断检查节点是否仍处于活动状态。 对于每个节点，它将向其pinglist中的节点发送“ Ping”消息，如果它在给定条件下没有响应，它将认为此节点已经挂掉，并告知其他节点此节点已正式死亡。 为了使该系统具有可伸缩性，各个节点不会对每个节点执行ping操作，它们每次只能对4个节点执行ping操作，因此，我的系统最多可以承受4个并发故障。

当一个节点发生故障时，引入程序将重新分发pinglist，以确保每个节点都有4个要ping的节点。 如果这仅是4个随机节点，则可能是某些节点没有人可以ping通。 因此，我使分发过程轮流进行，因此每个节点将被某些节点ping通，以确保始终检测到故障。

```go

```



## 3 分布式文件存储

### 3.1 master选举

在我的实现中，将有一个master在该系统中存储文件的元信息。 使用基于环的选举算法选举该master，ID最高的节点将被选为主节点。 当一个主节点master被选出时，它将告诉所有节点他是主节点。 当任何结点检测到master结点挂掉时，它将重新启动并选举并选举一个新master。这个实现是在阅读了Raft论文后所完成的，虽然看上去同样是选举，但远没有Raft那么复杂以及完备，本系统中只是实现了一个最简单的选举算法。

### 3.2 文件存储

在bdfs分布式文件系统中，每个文件在系统中将具有4个副本。 当主机A使用“ put localname bdfsname”在bdfs中存储文件时，该节点将通过向主机发送“ STOREREQUEST”消息来通知master节点它要存储文件。 master节点将选择4个节点，并告诉主机A将文件发送到这四个节点。 master永远不知道该文件中存储了什么，也不一定存储在master中。 但是master会存储元信息，其中哪些文件存储在哪里以及特定文件有多少版本（不同版本意味着具有相同bdfsname的文件在该系统中存储了多次）的元信息。

还有需要说明的是，bdfs没有将原始名称bdfsname存储到系统中，我将首先对该bdfsname进行哈希处理以获得字符串并在其末尾附加一个版本号，例如，可以存储文件名hello_world 如13213151312313123 | 0所示，0是版本号。 bdfs中对bdfsname进行了哈希处理和映射，而不是简单地将其存储为原始名称。

### 3.3 多版本存储

为了简化难度，这里在存储不同版本的文件时，仅被视为不同的文件，而没有实现像Git那样强大的版本管理机制。 bdfs中文件存储的版本为hashed_bdfsanme | num，并且它们不一定存储在同一台计算机上。 bdfs文件系统的master将使用相同的bdfsname，以便于管理每个版本的存储位置。

当在终端使用“ get bdfsname”时，主机B将向master发送“ GETREQUEST”消息，然后master将告诉主机B一个存储该文件的节点，然后主机B可以从该节点下载该文件。 GET将默认发送回最新版本的文件。 但是我们也可以使用“ get-versions”来指定我们要获取的版本数。

### 3.4 文件备份

每上传一个新文件，该文件会被备份到4个不同的节点上。如果有一些新节点加入，则master将检查某些文件的重复数是否少于4，如果是，它将告诉某些主机将文件发送到该新节点以达到4重复状态。如果有一些节点文件，master将检查某些文件是否少于4个副本，如果是，它将尝试将此文件发送到其他节点以达到4个副本。

如果master节点挂掉了，则无法在该系统中存储任何新文件，并且当节点检测到主节点故障时，将进行新的选择。 选举完成后，新的主服务器将使用“ Askfile”询问每个节点在其文件系统中存储的内容。 并使用此信息来重建文件元信息数据库。

## 4 总结

### 4.1 作业总结

刘老师布置的分布式系统大作业是非常有挑战性的，这里我选择了完成一个分布式文件系统。因为之前对网络编程比较熟练了，实习的时候也参与过服务器的开发，而我也对分布式存储比较感兴趣，便想着写了一个分布式文件存储系统。开始考虑是用C++实现，因为自己对C++网络编程很熟悉，也比较有信心，但是前面的分布式通信实现，已经让我觉得很难了，考虑的东西太多了。于是想起来Go，这里不得不说Go的协程和Channel是真的好用，代码量大大减少了。整个作业做下来，不仅是学习了分布式文件存储，同样我对分布式通信这块也更加熟悉了。

### 4.2 课程总结

很幸运选择了刘老师的《分布式系统》课程，8周（实际7周）的课程，两个月的学习，作为非科班出身的我不仅接触到了新知识和新世界，同时对计算机基础知识的理解也更加深刻了。刘老师上课气氛会比较活跃，不容易睡觉，也不容易分心。非常感谢刘老师，祝刘老师工作顺心，身体健康。