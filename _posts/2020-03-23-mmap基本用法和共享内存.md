---
layout:     post
title:      mmap基本用法和共享内存
subtitle:   用mmap写文件及共享内存
date:       2020-03-23
author:     bbkgl
header-img: img/post-bg-0006.jpg
catalog: true
tags:
    - linux
---

>莫道男儿心如铁
>
>君不见满川红叶
>
>尽是离人眼中血

前面写了一篇文章[关于luajit2.05中的内存限制](<https://bbkgl.github.io/2020/03/10/luajit-bitmem/>)，有讲到mmap分配内存中的一些问题，今天就自己动手过一下mmap文件映射内存以及mmap如何共享内存。

## 文件映射内存

```cpp
#include <cstdio>
#include <sys/mman.h>
#include <cstring>
#include <iostream>
#include <sys/wait.h>
#include <fcntl.h>
#include <unistd.h>

int main() {
    int fd = open("/dev/zero", O_RDWR, 0);
    void *addr = mmap(nullptr, 4, PROT_READ | PROT_WRITE, MAP_FILE | MAP_SHARED, fd, 0);
    printf("%d\n", *(int *)addr);
    munmap(addr, 4);
    close(fd);
    return 0;
}
```

下面文件不能为空！

```cpp
#include <cstdio>
#include <sys/mman.h>
#include <cstring>
#include <iostream>
#include <sys/wait.h>
#include <fcntl.h>
#include <unistd.h>

int main() {
    int fd = open("2333.txt", O_RDWR, 0);
    void *addr = mmap(nullptr, 4, PROT_READ | PROT_WRITE, MAP_FILE | MAP_SHARED, fd, 0);
    printf("%d\n", *(int *)addr);
    munmap(addr, 4);
    close(fd);
    return 0;
}
```

## 共享内存

```cpp
#include <cstdio>
#include <sys/mman.h>
#include <cstring>
#include <iostream>
#include <sys/wait.h>
#include <fcntl.h>
#include <unistd.h>

int main() {
    int fd = open("/dev/zero", O_RDWR, 0);
    void *addr = mmap(nullptr, 4, PROT_READ | PROT_WRITE, MAP_FILE | MAP_SHARED, fd, 0);
    if (fork() == 0) {
        *(int *)addr = 2333;
        printf("val in process %d is %d.\n", getpid(), *(int *)addr);
        munmap(addr, 4);
        close(fd);
        exit(0);
    }
    wait(nullptr);
    printf("val in process %d is %d.\n", getpid(), *(int *)addr);
    munmap(addr, 4);
    close(fd);
    return 0;
}
```

