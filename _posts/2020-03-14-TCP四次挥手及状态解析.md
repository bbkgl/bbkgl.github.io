---
layout:     post
title:      TCP四次挥手及状态解析
subtitle:   天气真好
date:       2020-03-14
author:     bbkgl
header-img: img/post-bg-0006.jpg
catalog: true
tags:
    - 计算机网络
---

>试问岭南应不好
>
>却道：此心安处是吾乡

理解TCP本身是基于连接的全双工协议，就能够理解TCP的三次握手和四次挥手了，三次握手的目的是确认双方都能收发数据了，随后就能进行通信了；而四次挥手的目的就是双方数据都发送完了，都确认要断开了。

## TCP四次挥手

建立连接需要三次握手，断开连接需要四次握手，可以形象的比喻为下面的对话：

- 套接字A：“任务处理完毕，我希望断开连接。”
- 套接字B：“哦，是吗？请稍等，我准备一下。”
- 等待片刻后……
- 套接字B：“我准备好了，可以断开连接了。”
- 套接字A：“好的，谢谢合作。”

给个图更加清晰：

![20200314200538.png](https://raw.githubusercontent.com/bbkglpic/picpic/master/img/20200314200538.png)

与三次握手一样，四次握手的关键仍然是把各个序号理清楚。以图为例，简述一下过程：

1. 客户端调用close()函数，发出了第一个TCP数据包，其中标志位FIN置为1，序号值为5000，此时客户端进入状态FIN_WAIT_1；
2. 服务端收到后，发现FIN标志位为1，知道客户端是要关闭连接了，于是马上回复确认包，ACK位置1，进入CLOSE_WAIT状态，而客户端收到确认后，就进入了FIN_WAIT_2；
3. 服务端在确认所有数据发送完后，也会发送FIN包，此时也会把ACK标志位置为1，并加上序列号，进入LAST_ACK状态，等待客户端回复确认；
4. 客户端收到服务端的FIN包，立即回复确认，确认号等于接受到的序列号+1，于是进入了TIME_WAIT状态。

### 半关闭状态是什么？

其实在任何一方发送完FIN包的时候，都是半关闭状态，即关闭了输入端，此时还是能接收

