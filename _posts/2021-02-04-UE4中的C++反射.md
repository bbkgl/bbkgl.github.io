---
layout:     post
typora-root-url: ..
title:      UE4中C++反射实现
subtitle:   unreal header tool
date:       2021-02-04
author:     bbkgl
header-img: img/post-bg-0015.jpg
catalog: true
tags:
    - UE4
    - C++
---

> 夜深忽梦少年事
>
> 梦啼妆泪红阑干

之前研究C/C++调试器的时候，有思考过C++反射实现的问题。按照我不成熟的设想，反射必须付出内存开销的代价，因为反射需要一定的格式化调试信息描述内存布局。不过之前在知乎上看到过，C++标准协会想实现的反射是*编译期反射*，目标还是零开销抽象，听说进度喜人。

用Unity的时候，C#的反射就非常好用，不过C#是直接作为Unity引擎交互的唯一脚本存在的，且C#有Unity嵌入的mono虚拟机支持，本就具有很多的动态特性，所以反射的作用并不是很明显，而UE4中，C++作为静态纯编译型语言，需要与蓝图进行频繁交互，同时与编辑器交互，反射的作用就凸显出来了。

这几篇文章，我选择从反射开始讲，因为反射是UE4中C++动态特性的基础，后面的蓝图虚拟机函数/事件调用也都基于此。

## 如果要实现运行时反射

关于运行时反射，应该至少需要记录以下信息。

**类/结构体的反射**

1. 对象的地址
2. 类对象的类型/内存布局信息

**成员变量反射**

1. 成员变量的地址
2. 成员变量的名字
3. 成员变量的类型/内存布局信息

**成员函数反射**

1. 成员函数的地址
2. 成员函数的名字
3. 成员变量的签名信息

要完成以上的信息记录，一般可以通过一个注册操作来实现，即将上述信息全部注册/登记到一个表中。在其他语言C#/Java中，这个表就对应元数据或者元表。

![](https://img-blog.csdn.net/20141227213922179)



## UE4中反射原理（UHT/UBT）

这里还是通过一个例子进行讲解，然后进行总结。。。其实就是各个宏的展开。

### 展开所有宏，示例

luajit源码中已经看了很多宏，UE4中的这些宏嵌套也算是有些熟悉了。

 通过在注册函数（StaticRegisterNativesAThirdPersonCPPTestCharacter）中打断点查看调用路径。

### 原理概述

